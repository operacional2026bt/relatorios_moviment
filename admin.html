<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrador - Bel-tour</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .restrito { width: 100%; max-width: 400px; display: none; }
        #login { width: 100%; max-width: 400px; margin-top: 50px; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        h2 { color: #00e676; font-size: 14px; text-transform: uppercase; margin-bottom: 15px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-ok { background: #00e676; color: #000; margin-bottom: 10px; }
        .btn-at { background: #333; color: #00e676; border: 1px solid #00e676; font-size: 12px; margin-bottom: 10px; }
        .linha-mot { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding: 10px 0; font-size: 13px; }
        .acoes { display: flex; gap: 8px; }
        .btn-edit { background: #0288d1; color: white; padding: 6px 10px; border-radius: 4px; font-size: 10px; }
        .btn-excluir { background: #b71c1c; color: white; padding: 6px 12px; border-radius: 4px; font-size: 10px; }
        .item-log { border-bottom: 1px solid #333; padding: 10px 0; font-size: 11px; list-style: none; color: #aaa; }
    </style>
</head>
<body>
    <div id="login">
        <div class="card">
            <h2>ACESSO ADMINISTRADOR</h2>
            <input type="password" id="pass" placeholder="Senha de Acesso">
            <button class="btn-ok" onclick="acessar()">ENTRAR</button>
        </div>
    </div>

    <div class="restrito" id="painel">
        <h2>CADASTRAR / EDITAR</h2>
        <div class="card">
            <input type="number" id="mat" placeholder="Matrícula">
            <input type="text" id="nome" placeholder="Nome do Motorista">
            <input type="text" id="senha" placeholder="Senha (opcional)">
            <button class="btn-ok" onclick="salvar()">SALVAR MOTORISTA</button>
        </div>

        <h2>MOTORISTAS NO BANCO</h2>
        <div class="card">
            <button class="btn-at" onclick="listarMotoristas()">ATUALIZAR LISTAGEM</button>
            <div id="lista-motoristas"></div>
        </div>

        <h2>HISTÓRICO DE LOGS</h2>
        <div class="card">
            <button class="btn-at" onclick="carregarLogs()">VER MOVIMENTAÇÕES</button>
            <ul id="log-list" style="padding:0"></ul>
        </div>
    </div>

    <script>
        const SENHA_ADM = "TIAGO2026"; 

        function acessar() {
            if(document.getElementById('pass').value === SENHA_ADM) {
                document.getElementById('login').style.display = 'none';
                document.getElementById('painel').style.display = 'block';
                listarMotoristas();
                carregarLogs();
            } else { alert("Senha incorreta"); }
        }

        async function salvar() {
            const m = { mat: document.getElementById('mat').value, nome: document.getElementById('nome').value.toUpperCase(), senha: document.getElementById('senha').value };
            if(!m.mat || !m.nome) return alert("Preencha Matrícula e Nome!");
            
            const res = await fetch('/api/gerenciar', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ acao: 'salvar_motorista', motorista: m }) 
            });

            if(res.ok) {
                alert("Dados Enviados!");
                listarMotoristas();
                document.getElementById('mat').value = '';
                document.getElementById('nome').value = '';
                document.getElementById('senha').value = '';
            }
        }

        async function listarMotoristas() {
            const res = await fetch('/api/gerenciar', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ acao: 'listar_todos_motoristas' }) 
            });
            const dados = await res.json();
            const div = document.getElementById('lista-motoristas');
            div.innerHTML = dados.map(m => `
                <div class="linha-mot">
                    <span><b>${m.mat}</b> - ${m.nome}</span>
                    <div class="acoes">
                        <button class="btn-edit" onclick="prepararEdicao('${m.mat}', '${m.nome}', '${m.senha}')">EDITAR</button>
                        <button class="btn-excluir" onclick="excluirDirect('${m.mat}')">APAGAR</button>
                    </div>
                </div>
            `).join('');
        }

        function prepararEdicao(mat, nome, senha) {
            document.getElementById('mat').value = mat;
            document.getElementById('nome').value = nome;
            document.getElementById('senha').value = (senha === "undefined" || senha === "null") ? "" : senha;
            window.scrollTo(0,0);
        }

        async function excluirDirect(mat) {
            if(!confirm("Excluir matrícula " + mat + "?")) return;
            await fetch('/api/gerenciar', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ acao: 'excluir_motorista', mat: mat }) 
            });
            listarMotoristas();
        }

        async function carregarLogs() {
            const res = await fetch('/api/gerenciar', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ acao: 'listar_logs' }) 
            });
            const logs = await res.json();
            document.getElementById('log-list').innerHTML = logs.map(l => {
                const item = JSON.parse(l);
                return `<li class="item-log"><b>${new Date(item.data).toLocaleString('pt-BR')}</b><br>${item.usuario}: ${item.detalhes}</li>`;
            }).join('');
        }
    </script>
</body>
</html>
