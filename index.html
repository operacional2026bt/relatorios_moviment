<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movimenta√ß√£o de Vans - Bel-tour</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #121212; color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 400px; }
        h2 { color: #00e676; text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; width: 100%; }
        label { font-size: 14px; margin-bottom: 5px; color: #b0b0b0; }
        .time-row { display: flex; gap: 5px; }
        select, input {
            background-color: #1e1e1e; border: 1px solid #333; color: white;
            padding: 12px; border-radius: 8px; font-size: 16px; outline: none; width: 100%;
        }
        .nome-display {
            font-size: 18px; font-weight: bold; color: #00e676;
            padding: 10px 5px; min-height: 40px; display: block;
        }
        .check-group {
            display: flex; align-items: center; gap: 10px;
            background: #1e1e1e; padding: 12px; border-radius: 8px;
            border: 1px solid #333; margin-bottom: 10px; cursor: pointer;
            user-select: none;
        }
        .check-group.disabled { opacity: 0.2; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }
        .check-group input { width: 22px; height: 22px; accent-color: #00e676; cursor: pointer; }
        .check-group span { flex: 1; cursor: pointer; }

        #preview-container { display: none; margin-top: 10px; margin-bottom: 20px; }
        .preview-box {
            background-color: #1a1a1a; border-left: 4px solid #00e676;
            padding: 15px; border-radius: 4px; font-size: 14px; white-space: pre-wrap; color: #aaa; margin-bottom: 10px;
        }
        .btn-copy {
            background-color: #00e676; color: #000; border: none; padding: 15px;
            border-radius: 8px; font-weight: bold; font-size: 16px; width: 100%; cursor: pointer;
        }
        .btn-short {
            background-color: #00c853; color: #000; border: none; padding: 10px;
            border-radius: 8px; font-weight: bold; font-size: 13px; width: 100%; margin-top: 8px; cursor: pointer;
        }
        .btn-clear { background-color: #333; color: #e0e0e0; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 15px; cursor: pointer; }
        .status-msg { text-align: center; font-size: 12px; margin-top: 10px; color: #00e676; visibility: hidden; }
        .footer-sig { margin-top: 40px; font-size: 10px; color: #444; text-align: center; }

        .access-row { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        .access-link { color: #333; font-size: 9px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; user-select: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>MOVIMENTA√á√ÉO DE VANS</h2>

    <div class="form-group">
        <label>Ponto de Embarque / Atividade</label>
        <select id="embarque" onchange="verificarTipo()">
            <option value="EMBARQUE CENTRAL">EMBARQUE CENTRAL</option>
            <option value="EMBARQUE LGO DO MACHADO">EMBARQUE LGO DO MACHADO</option>
            <option value="EMBARQUE LGO DO MACHADO (MOTORISTAS DE PASSE)">EMBARQUE LGO DO MACHADO (MOTORISTAS DE PASSE)</option>
            <option value="PAINEIRAS">PAINEIRAS</option>
            <option value="ABASTECIMENTO">ABASTECIMENTO</option>
        </select>
    </div>

    <div class="form-group">
        <label>Hor√°rio (Hora : Min)</label>
        <div class="time-row">
            <select id="hora" onchange="validarVisibilidade()"></select>
            <select id="minuto" onchange="validarVisibilidade()"></select>
        </div>
    </div>

    <div class="form-group">
        <label id="label-quantidade">Qtd. Integrantes</label>
        <input type="number" id="quantidade" placeholder="Ex: 13" oninput="validarVisibilidade()">
    </div>

    <div class="form-group">
        <label>N√∫mero da Van</label>
        <input type="text" id="van" placeholder="Ex: 130" oninput="validarVisibilidade()">
    </div>

    <div class="form-group">
        <label>Adicionais</label>
        <div class="check-group lock-on-abast" onclick="toggleCheck('icmbio', event)">
            <input type="checkbox" id="icmbio" onchange="validarVisibilidade()" onclick="event.stopPropagation()">
            <span>ICMbio</span>
        </div>
        <div class="check-group" onclick="toggleCheck('incHorario', event)">
            <input type="checkbox" id="incHorario" onchange="validarVisibilidade()" onclick="event.stopPropagation()">
            <span>Incluir Hor√°rio no Resumo</span>
        </div>
        <div class="check-group lock-on-abast" onclick="toggleCheck('bateVolta', event)">
            <input type="checkbox" id="bateVolta" onchange="validarVisibilidade()" onclick="event.stopPropagation()">
            <span>Bate e Volta</span>
        </div>
        <div class="check-group lock-on-abast" onclick="toggleCheck('segundoHorario', event)">
            <input type="checkbox" id="segundoHorario" onchange="validarVisibilidade()" onclick="event.stopPropagation()">
            <span>Segundo Hor√°rio</span>
        </div>
        <div class="check-group lock-on-abast" onclick="toggleCheck('extraAbast', event)">
            <input type="checkbox" id="extraAbast" onchange="validarVisibilidade()" onclick="event.stopPropagation()">
            <span>+ Abastecimento</span>
        </div>
    </div>

    <div class="form-group">
        <label id="label-matricula">Matr√≠cula</label>
        <input type="number" id="matricula" placeholder="Digite a matr√≠cula" oninput="buscarMotorista()">
    </div>

    <div class="form-group">
        <label>Motorista Identificado:</label>
        <span id="nome-exibicao" class="nome-display">Aguardando matr√≠cula...</span>
    </div>

    <div id="preview-container">
        <div id="preview" class="preview-box"></div>
        <div id="preview-curto" class="preview-box"></div>
    </div>

    <button class="btn-copy" id="btnCopiar" onclick="copiarRelatorio('completo')">COPIAR RELAT√ìRIO</button>
    <button class="btn-short" id="btnCopiarCurto" onclick="copiarRelatorio('curto')">COPIAR CURTO (WHATSAPP)</button>
    <button class="btn-clear" onclick="limparCampos()">LIMPAR TUDO</button>

    <p id="status" class="status-msg">Copiado com sucesso! ‚úÖ</p>

    <div class="footer-sig">by Tiago C Araujo ‚Äì Ara√∫jo II ‚Äì mat 3240 ‚Äì Bel-tour üöå</div>
    
    <div class="access-row">
        <div class="access-link" onclick="acesso('adm')">ADM</div>
        <div class="access-link" onclick="acesso('suporte')">Suporte</div>
    </div>
</div>

<script>
    // Inicializa os selects de hora e minuto
    const sH = document.getElementById('hora'); const sM = document.getElementById('minuto');
    for(let i=0; i<24; i++) { let h = i<10?'0'+i:i; sH.options[sH.options.length] = new Option(h, h); }
    for(let i=0; i<60; i++) { let m = i<10?'0'+i:i; sM.options[sM.options.length] = new Option(m, m); }
    const agora = new Date(); sH.value = agora.getHours() < 10 ? '0' + agora.getHours() : agora.getHours(); sM.value = agora.getMinutes() < 10 ? '0' + agora.getMinutes() : agora.getMinutes();

    function toggleCheck(id, ev) { 
        const el = document.getElementById(id); if (el.closest('.check-group').classList.contains('disabled')) return;
        if (ev.target !== el) el.checked = !el.checked; validarVisibilidade();
    }

    function obterSaudacao() { const h = parseInt(sH.value); return (h >= 5 && h < 12) ? "Bom dia!" : (h >= 12 && h < 18) ? "Boa tarde!" : "Boa noite!"; }

    // BUSCA DIN√ÇMICA NO BANCO DE DADOS
    async function buscarMotorista() {
        const mat = document.getElementById('matricula').value;
        const display = document.getElementById('nome-exibicao');
        
        if (mat.length >= 3) {
            try {
                const res = await fetch(`/api/gerenciar?acao=buscar_motorista&matricula=${mat}`);
                const dados = await res.json();
                if (dados && dados.nome) {
                    display.innerText = dados.nome;
                    display.style.color = "#00e676";
                } else {
                    display.innerText = "MOTORISTA N√ÉO LOCALIZADO";
                    display.style.color = "#ff5252";
                }
            } catch (e) { display.innerText = "ERRO NA BUSCA"; }
        } else {
            display.innerText = "Aguardando matr√≠cula...";
            display.style.color = "#444";
        }
        validarVisibilidade();
    }

    function verificarTipo() {
        const emb = document.getElementById('embarque').value; const locks = document.querySelectorAll('.lock-on-abast');
        document.getElementById('label-quantidade').innerText = (emb === "ABASTECIMENTO") ? "KM" : "Qtd. Integrantes";
        locks.forEach(div => { if (emb === "ABASTECIMENTO") { div.classList.add('disabled'); div.querySelector('input').checked = false; } else div.classList.remove('disabled'); });
        validarVisibilidade();
    }

    function validarVisibilidade() {
        const q = document.getElementById('quantidade').value; const v = document.getElementById('van').value; const m = document.getElementById('matricula').value;
        const icm = document.getElementById('icmbio').checked; const bv = document.getElementById('bateVolta').checked; const sh = document.getElementById('segundoHorario').checked; const ab = document.getElementById('extraAbast').checked;
        
        document.getElementById('preview-container').style.display = (q || v || m || icm || bv || sh || ab) ? 'block' : 'none';
        document.getElementById('preview').innerText = gerarTexto('completo'); document.getElementById('preview-curto').innerText = gerarTexto('curto');
    }

    function gerarTexto(tipo) {
        const emb = document.getElementById('embarque').value; const h = sH.value; const mi = sM.value;
        const q = document.getElementById('quantidade').value || "0"; const v = document.getElementById('van').value || "";
        const n = document.getElementById('nome-exibicao').innerText; const mat = document.getElementById('matricula').value;
        const bv = document.getElementById('bateVolta').checked; const sh = document.getElementById('segundoHorario').checked;
        const ab = document.getElementById('extraAbast').checked; const icm = document.getElementById('icmbio').checked; const incH = document.getElementById('incHorario').checked;
        const saudacao = obterSaudacao();
        const motoristaValido = mat && !n.includes("N√ÉO LOCALIZADO") && !n.includes("Aguardando");

        if (tipo === 'curto') {
            let res = `${saudacao}\n${incH ? h+':'+mi+'\n' : ''}\n${v?'VTR '+v+'\n':''}${emb}${icm?' (ICMbio)':''}\n${q} ${emb==='ABASTECIMENTO'?'KM':'Integrantes'}`;
            if (sh) res += `\nSegundo Hor√°rio`;
            let extras = []; if (bv) extras.push("Bate e volta"); if (ab) extras.push("+Abastecimento");
            if (extras.length > 0) res += ` (${extras.join(" / ")})`;
            if (motoristaValido) res += `\n\nüë§ ${n}\nüÜî ${mat}`;
            return res;
        } else {
            let txt = `${saudacao}\n\n*RELAT√ìRIO DE VANS*\nüìç Local: ${emb}${icm?' (ICMbio)':''}\n‚è∞ Hor√°rio: ${h}:${mi}\n${emb==='ABASTECIMENTO'?'üõ£Ô∏è KM':'üë• Qtd'}: ${q}\n${v?'üöê Van: '+v+'\n':''}`;
            if (sh) txt += `‚åõ Segundo Hor√°rio\n`;
            let obs = []; if (bv) obs.push("Bate e Volta"); if (ab) obs.push("+ Abastecimento");
            if (obs.length > 0) txt += `üìù Obs: ${obs.join(" / ")}\n`;
            if (motoristaValido) txt += `\nüë§ Motorista: ${n}\nüÜî Matr√≠cula: ${mat}`;
            return txt;
        }
    }

    function copiarRelatorio(tipo) {
        const t = gerarTexto(tipo);
        navigator.clipboard.writeText(t).then(() => {
            const s = document.getElementById('status'); s.style.visibility = 'visible'; setTimeout(() => s.style.visibility = 'hidden', 2000);
        });
    }

    function acesso(nivel) {
        const s = (nivel === 'adm') ? 'aDmtiago2026' : 'Stiago2026';
        const p = prompt("Chave de acesso:");
        if (p === s) window.location.href = 'admin.html';
        else if (p !== null) alert("Negado.");
    }

    function limparCampos() { document.querySelectorAll('input').forEach(i => i.value = ""); document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false); buscarMotorista(); }
</script>
</body>
</html>
