<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movimenta√ß√£o de Vans - Bel-tour</title>
    <script src="motoristas.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #121212; color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 400px; }
        h2 { color: #00e676; text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; width: 100%; }
        label { font-size: 14px; margin-bottom: 5px; color: #b0b0b0; }
        .time-row { display: flex; gap: 5px; }
        select, input {
            background-color: #1e1e1e; border: 1px solid #333; color: white;
            padding: 12px; border-radius: 8px; font-size: 16px; outline: none; width: 100%;
        }
        .nome-display {
            font-size: 18px; font-weight: bold; color: #00e676;
            padding: 10px 5px; min-height: 40px; display: block;
        }
        
        .check-group {
            display: flex; align-items: center; gap: 10px;
            background: #1e1e1e; padding: 12px; border-radius: 8px;
            border: 1px solid #333; margin-bottom: 10px; cursor: pointer;
        }
        .check-group.disabled { opacity: 0.2; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }
        .check-group input { width: 22px; height: 22px; accent-color: #00e676; }

        #preview-container { display: none; margin-top: 10px; margin-bottom: 20px; }
        .preview-box {
            background-color: #1a1a1a; border-left: 4px solid #00e676;
            padding: 15px; border-radius: 4px; font-size: 14px; white-space: pre-wrap; color: #aaa; margin-bottom: 10px;
        }
        .btn-copy {
            background-color: #00e676; color: #000; border: none; padding: 15px;
            border-radius: 8px; font-weight: bold; font-size: 16px; width: 100%; cursor: pointer;
        }
        .btn-short {
            background-color: #00c853; color: #000; border: none; padding: 10px;
            border-radius: 8px; font-weight: bold; font-size: 13px; width: 100%; margin-top: 8px; cursor: pointer;
        }
        .btn-clear { background-color: #333; color: #e0e0e0; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 15px; cursor: pointer; }
        .status-msg { text-align: center; font-size: 12px; margin-top: 10px; color: #00e676; visibility: hidden; }
        .footer-sig { margin-top: 40px; font-size: 10px; color: #444; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>MOVIMENTA√á√ÉO DE VANS</h2>

    <div class="form-group">
        <label>Ponto de Embarque / Atividade</label>
        <select id="embarque" onchange="verificarTipo()">
            <option value="EMBARQUE CENTRAL">EMBARQUE CENTRAL</option>
            <option value="EMBARQUE LGO DO MACHADO">EMBARQUE LGO DO MACHADO</option>
            <option value="EMBARQUE LGO DO MACHADO (MOTORISTAS DE PASSE)">EMBARQUE LGO DO MACHADO (MOTORISTAS DE PASSE)</option>
            <option value="PAINEIRAS">PAINEIRAS</option>
            <option value="ABASTECIMENTO">ABASTECIMENTO</option>
        </select>
    </div>

    <div class="form-group">
        <label>Hor√°rio (Hora : Min)</label>
        <div class="time-row">
            <select id="hora" onchange="validarVisibilidade()"></select>
            <select id="minuto" onchange="validarVisibilidade()"></select>
        </div>
    </div>

    <div class="form-group">
        <label id="label-quantidade">Qtd. Integrantes</label>
        <input type="number" id="quantidade" placeholder="Ex: 13" oninput="validarVisibilidade()">
    </div>

    <div class="form-group">
        <label>N√∫mero da Van</label>
        <input type="text" id="van" placeholder="Ex: 130" oninput="validarVisibilidade()">
    </div>

    <div class="form-group">
        <label>Adicionais</label>
        <div class="check-group lock-on-abast" id="div-icmbio">
            <input type="checkbox" id="icmbio" onchange="validarVisibilidade()">
            <span>ICMbio</span>
        </div>
        <div class="check-group">
            <input type="checkbox" id="incHorario" onchange="validarVisibilidade()">
            <span>Incluir Hor√°rio no Resumo</span>
        </div>
        <div class="check-group lock-on-abast" id="div-bv">
            <input type="checkbox" id="bateVolta" onchange="validarVisibilidade()">
            <span>Bate e Volta</span>
        </div>
    </div>

    <div class="form-group">
        <label id="label-matricula">Matr√≠cula</label>
        <input type="number" id="matricula" placeholder="Digite a matr√≠cula" oninput="buscarMotorista()">
    </div>

    <div class="form-group">
        <label>Motorista:</label>
        <span id="nome-exibicao" class="nome-display">Aguardando matr√≠cula...</span>
    </div>

    <div id="preview-container">
        <div id="preview" class="preview-box"></div>
        <div id="preview-curto" class="preview-box"></div>
    </div>

    <button class="btn-copy" id="btnCopiar" onclick="copiarRelatorio('completo')">COPIAR RELAT√ìRIO</button>
    <button class="btn-short" id="btnCopiarCurto" onclick="copiarRelatorio('curto')">COPIAR CURTO (WHATSAPP)</button>
    
    <button class="btn-clear" onclick="limparCampos()">LIMPAR TUDO</button>

    <p id="status" class="status-msg">Copiado com sucesso! ‚úÖ</p>

    <div class="footer-sig">by Tiago C Araujo ‚Äì Bel-tour üöå</div>
</div>

<script>
    // Gerar op√ß√µes de tempo
    const sH = document.getElementById('hora');
    const sM = document.getElementById('minuto');
    for(let i=0; i<24; i++) { let h = i<10?'0'+i:i; sH.options[sH.options.length] = new Option(h, h); }
    for(let i=0; i<60; i++) { let m = i<10?'0'+i:i; sM.options[sM.options.length] = new Option(m, m); }
    
    const agora = new Date();
    sH.value = agora.getHours() < 10 ? '0' + agora.getHours() : agora.getHours();
    sM.value = agora.getMinutes() < 10 ? '0' + agora.getMinutes() : agora.getMinutes();

    function verificarTipo() {
        const emb = document.getElementById('embarque').value;
        const locks = document.querySelectorAll('.lock-on-abast');
        document.getElementById('label-quantidade').innerText = (emb === "ABASTECIMENTO") ? "KM" : "Qtd. Integrantes";
        locks.forEach(div => {
            div.classList.toggle('disabled', emb === "ABASTECIMENTO");
            if(emb === "ABASTECIMENTO") div.querySelector('input').checked = false;
        });
        validarVisibilidade();
    }

    function buscarMotorista() {
        const mat = document.getElementById('matricula').value;
        const display = document.getElementById('nome-exibicao');
        if (typeof bancoMotoristas !== 'undefined' && bancoMotoristas[mat]) {
            display.innerText = bancoMotoristas[mat];
            display.style.color = "#00e676";
        } else {
            display.innerText = mat ? "MOTORISTA N√ÉO LOCALIZADO" : "Aguardando matr√≠cula...";
            display.style.color = mat ? "#ff5252" : "#444";
        }
        validarVisibilidade();
    }

    function validarVisibilidade() {
        const q = document.getElementById('quantidade').value;
        const v = document.getElementById('van').value;
        const m = document.getElementById('matricula').value;
        document.getElementById('preview-container').style.display = (q || v || m) ? 'block' : 'none';
        document.getElementById('preview').innerText = gerarTexto('completo');
        document.getElementById('preview-curto').innerText = gerarTexto('curto');
    }

    function gerarTexto(tipo) {
        const emb = document.getElementById('embarque').value;
        const h = sH.value; const mi = sM.value;
        const q = document.getElementById('quantidade').value || "0";
        const v = document.getElementById('van').value || "---";
        const n = document.getElementById('nome-exibicao').innerText;
        const mat = document.getElementById('matricula').value;
        const icm = document.getElementById('icmbio').checked;
        const bv = document.getElementById('bateVolta').checked;
        const incH = document.getElementById('incHorario').checked;

        if (tipo === 'curto') {
            let res = `${incH ? h+':'+mi+'\n' : ''}${v}\n${emb}${icm?' (ICMbio)':''}\n${q} ${emb==='ABASTECIMENTO'?'KM':'Inter'}${bv?' (B/V)':''}\n${n}`;
            return res;
        } else {
            return `*RELAT√ìRIO DE VANS*\nüìç Local: ${emb}${icm?' (ICMbio)':''}\n‚è∞ Hor√°rio: ${h}:${mi}\nüöê Van: ${v}\n${emb==='ABASTECIMENTO'?'üõ£Ô∏è KM':'üë• Qtd'}: ${q}\n${bv?'üìù Obs: Bate e Volta\n':''}üë§ Motorista: ${n}\nüÜî Matr√≠cula: ${mat}`;
        }
    }

    // FUN√á√ÉO QUE CONECTA COM O ADMINISTRADOR
    async function copiarRelatorio(tipo) {
        const texto = gerarTexto(tipo);
        const m = document.getElementById('matricula').value;
        const n = document.getElementById('nome-exibicao').innerText;

        navigator.clipboard.writeText(texto).then(async () => {
            const status = document.getElementById('status');
            status.style.visibility = 'visible';
            setTimeout(() => { status.style.visibility = 'hidden'; }, 2000);

            // Envia o Log para o Banco (Invis√≠vel para o motorista)
            if (m && !n.includes("Aguardando") && !n.includes("N√ÉO")) {
                try {
                    await fetch('/api/gerenciar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            acao: 'registrar_log',
                            log: { usuario: `${n} (${m})`, texto: `Gerou relat√≥rio ${tipo} - Van ${document.getElementById('van').value || '?'}` }
                        })
                    });
                } catch (e) { console.log("Erro log silencioso"); }
            }
        });
    }

    function limparCampos() {
        document.getElementById('quantidade').value = "";
        document.getElementById('van').value = "";
        document.getElementById('matricula').value = "";
        document.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
        buscarMotorista();
    }
</script>
</body>
</html>
